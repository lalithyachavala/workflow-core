{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/lib/env.ts"],"sourcesContent":["export const env = {\n  mongodbUri: process.env.MONGODB_URI || \"mongodb://localhost:27017/workforce\",\n  accessSecret: process.env.JWT_ACCESS_SECRET || \"dev-access-secret-change-me\",\n  refreshSecret: process.env.JWT_REFRESH_SECRET || \"dev-refresh-secret-change-me\",\n  accessTokenTtlMinutes: Number(process.env.ACCESS_TOKEN_TTL_MINUTES || \"15\"),\n  refreshTokenTtlDays: Number(process.env.REFRESH_TOKEN_TTL_DAYS || \"30\"),\n  geoFallbackCountry: process.env.GEOIP_FALLBACK_COUNTRY || \"Unknown\",\n  /** 32-byte hex key for AES-GCM embedding encryption. Generate: openssl rand -hex 32 */\n  faceEmbeddingKey: process.env.FACE_EMBEDDING_KEY || \"0000000000000000000000000000000000000000000000000000000000000000\",\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,MAAM;IACjB,YAAY,QAAQ,GAAG,CAAC,WAAW,IAAI;IACvC,cAAc,QAAQ,GAAG,CAAC,iBAAiB,IAAI;IAC/C,eAAe,QAAQ,GAAG,CAAC,kBAAkB,IAAI;IACjD,uBAAuB,OAAO,QAAQ,GAAG,CAAC,wBAAwB,IAAI;IACtE,qBAAqB,OAAO,QAAQ,GAAG,CAAC,sBAAsB,IAAI;IAClE,oBAAoB,QAAQ,GAAG,CAAC,sBAAsB,IAAI;IAC1D,qFAAqF,GACrF,kBAAkB,QAAQ,GAAG,CAAC,kBAAkB,IAAI;AACtD"}},
    {"offset": {"line": 63, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/lib/mongodb.ts"],"sourcesContent":["import mongoose from \"mongoose\";\nimport { env } from \"@/src/lib/env\";\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var mongooseConn: Promise<typeof mongoose> | undefined;\n}\n\nexport function connectMongo() {\n  if (!global.mongooseConn) {\n    global.mongooseConn = mongoose.connect(env.mongodbUri, { dbName: \"workforce\" });\n  }\n  return global.mongooseConn;\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAOO,SAAS;IACd,IAAI,CAAC,OAAO,YAAY,EAAE;QACxB,OAAO,YAAY,GAAG,kLAAQ,CAAC,OAAO,CAAC,yIAAG,CAAC,UAAU,EAAE;YAAE,QAAQ;QAAY;IAC/E;IACA,OAAO,OAAO,YAAY;AAC5B"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/db/models.ts"],"sourcesContent":["import mongoose, { Schema, type InferSchemaType } from \"mongoose\";\n\nconst userSchema = new Schema(\n  {\n    email: { type: String, unique: true, required: true, lowercase: true, trim: true },\n    passwordHash: { type: String, required: true },\n    roleIds: [{ type: Schema.Types.ObjectId, ref: \"Role\" }],\n    isActive: { type: Boolean, default: true },\n    profile: {\n      displayName: { type: String, default: \"\" },\n      profilePictureBase64: { type: String, default: \"\" },\n      employeeCode: { type: String, default: \"\" },\n      firstName: { type: String, default: \"\" },\n      lastName: { type: String, default: \"\" },\n      nationality: { type: String, default: \"\" },\n      dateOfBirth: { type: Date, default: null },\n      gender: { type: String, default: \"\" },\n      maritalStatus: { type: String, default: \"\" },\n      jobTitle: { type: String, default: \"\" },\n      department: { type: String, default: \"\" },\n      manager: { type: String, default: \"\" },\n      phone: { type: String, default: \"\" },\n      timezone: { type: String, default: \"\" },\n      skills: [{ type: String }],\n      education: { type: String, default: \"\" },\n      languages: [{ type: String }],\n      dependents: [{ type: String }],\n      contacts: [{ type: String }],\n    },\n  },\n  { timestamps: true },\n);\n\nconst roleSchema = new Schema(\n  {\n    name: { type: String, unique: true, required: true, trim: true },\n    description: { type: String, default: \"\" },\n    permissions: [{ type: String, required: true }],\n  },\n  { timestamps: true },\n);\n\nconst refreshTokenSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    tokenHash: { type: String, required: true, unique: true },\n    expiresAt: { type: Date, required: true, index: true },\n    revokedAt: { type: Date, default: null },\n  },\n  { timestamps: true },\n);\n\nconst deviceSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    hostname: { type: String, required: true },\n    osVersion: { type: String, default: \"\" },\n    deviceFingerprint: { type: String, required: true, index: true },\n    appVersion: { type: String, default: \"\" },\n  },\n  { timestamps: true },\n);\n\nconst faceTemplateSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, unique: true },\n    /** Encrypted embeddings per pose (AES-GCM). front, left, right. */\n    embeddingFront: { type: String, default: null },\n    embeddingLeft: { type: String, default: null },\n    embeddingRight: { type: String, default: null },\n    /** Model version for embedding compatibility. */\n    modelVersion: { type: Number, default: 1 },\n    status: { type: String, default: \"active\" },\n    /** @deprecated legacy single embedding - migrate to embeddingFront/Left/Right */\n    embeddingVector: [{ type: Number }],\n    version: { type: Number, default: 1 },\n  },\n  { timestamps: true },\n);\n\nconst attendanceEventSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    type: { type: String, enum: [\"clockIn\", \"clockOut\"], required: true },\n    timestamp: { type: Date, required: true, index: true },\n    ip: { type: String, default: \"\" },\n    geo: {\n      country: { type: String, default: \"\" },\n      city: { type: String, default: \"\" },\n      ll: [{ type: Number }],\n    },\n    deviceId: { type: Schema.Types.ObjectId, ref: \"Device\" },\n    faceScore: { type: Number, default: 0 },\n    verificationStatus: { type: String, default: \"pending\" },\n  },\n  { timestamps: true },\n);\n\nconst workSessionSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    clockInAt: { type: Date, required: true, index: true },\n    clockOutAt: { type: Date, default: null, index: true },\n    totalSeconds: { type: Number, default: 0 },\n    ipAtIn: { type: String, default: \"\" },\n    ipAtOut: { type: String, default: \"\" },\n    deviceIdAtIn: { type: Schema.Types.ObjectId, ref: \"Device\" },\n    deviceIdAtOut: { type: Schema.Types.ObjectId, ref: \"Device\" },\n  },\n  { timestamps: true },\n);\n\nconst auditLogSchema = new Schema(\n  {\n    actorUserId: { type: Schema.Types.ObjectId, ref: \"User\" },\n    action: { type: String, required: true },\n    details: { type: Schema.Types.Mixed, default: {} },\n  },\n  { timestamps: true },\n);\n\nconst awayAlertSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    employeeEmail: { type: String, required: true },\n    awayAt: { type: Date, required: true, default: () => new Date() },\n    minutesAway: { type: Number, required: true, default: 15 },\n  },\n  { timestamps: true },\n);\n\nconst companyStructureSchema = new Schema(\n  {\n    name: { type: String, required: true, trim: true },\n    address: { type: String, default: \"\" },\n    type: { type: String, default: \"Department\" },\n    country: { type: String, default: \"\" },\n    timeZone: { type: String, default: \"\" },\n    parentStructure: { type: String, default: \"\" },\n  },\n  { timestamps: true },\n);\n\nconst loginHistorySchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    loginTime: { type: Date, required: true },\n    loginTimeFormatted: { type: String, required: true },\n    ipAddress: { type: String, default: \"\" },\n    systemName: { type: String, default: \"\" },\n    location: { type: String, default: \"\" },\n  },\n  { timestamps: true },\n);\n\nexport type UserDoc = InferSchemaType<typeof userSchema>;\nexport type RoleDoc = InferSchemaType<typeof roleSchema>;\n\nexport const User = mongoose.models.User || mongoose.model(\"User\", userSchema);\nexport const Role = mongoose.models.Role || mongoose.model(\"Role\", roleSchema);\nexport const RefreshToken =\n  mongoose.models.RefreshToken || mongoose.model(\"RefreshToken\", refreshTokenSchema);\nexport const Device = mongoose.models.Device || mongoose.model(\"Device\", deviceSchema);\nexport const FaceTemplate =\n  mongoose.models.FaceTemplate || mongoose.model(\"FaceTemplate\", faceTemplateSchema);\nexport const AttendanceEvent =\n  mongoose.models.AttendanceEvent || mongoose.model(\"AttendanceEvent\", attendanceEventSchema);\nexport const WorkSession =\n  mongoose.models.WorkSession || mongoose.model(\"WorkSession\", workSessionSchema);\nexport const AuditLog = mongoose.models.AuditLog || mongoose.model(\"AuditLog\", auditLogSchema);\nexport const CompanyStructure =\n  mongoose.models.CompanyStructure || mongoose.model(\"CompanyStructure\", companyStructureSchema);\nexport const AwayAlert =\n  mongoose.models.AwayAlert || mongoose.model(\"AwayAlert\", awayAlertSchema);\nexport const LoginHistory =\n  mongoose.models.LoginHistory || mongoose.model(\"LoginHistory\", loginHistorySchema);\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 558, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/lib/tokens.ts"],"sourcesContent":["import crypto from \"crypto\";\nimport { SignJWT, jwtVerify } from \"jose\";\nimport { env } from \"@/src/lib/env\";\nimport { RefreshToken } from \"@/src/db/models\";\n\nconst accessSecret = new TextEncoder().encode(env.accessSecret);\nconst refreshSecret = new TextEncoder().encode(env.refreshSecret);\n\nexport type AccessTokenPayload = {\n  sub: string;\n  email: string;\n  roles: string[];\n};\n\nexport async function createAccessToken(payload: AccessTokenPayload) {\n  return new SignJWT(payload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(`${env.accessTokenTtlMinutes}m`)\n    .sign(accessSecret);\n}\n\nexport async function createRefreshToken(userId: string) {\n  const rawToken = crypto.randomUUID();\n  const tokenHash = crypto.createHash(\"sha256\").update(rawToken).digest(\"hex\");\n  const expiresAt = new Date(Date.now() + env.refreshTokenTtlDays * 24 * 60 * 60 * 1000);\n\n  await RefreshToken.create({ userId, tokenHash, expiresAt });\n  return rawToken;\n}\n\nexport async function verifyAccessToken(token: string) {\n  const { payload } = await jwtVerify(token, accessSecret);\n  return payload as unknown as AccessTokenPayload;\n}\n\nexport async function rotateRefreshToken(userId: string, incomingToken: string) {\n  const incomingHash = crypto.createHash(\"sha256\").update(incomingToken).digest(\"hex\");\n  const existing = await RefreshToken.findOne({ userId, tokenHash: incomingHash, revokedAt: null });\n  if (!existing || existing.expiresAt < new Date()) {\n    return null;\n  }\n\n  existing.revokedAt = new Date();\n  await existing.save();\n  return createRefreshToken(userId);\n}\n\nexport async function revokeRefreshToken(token: string) {\n  const tokenHash = crypto.createHash(\"sha256\").update(token).digest(\"hex\");\n  await RefreshToken.updateOne({ tokenHash, revokedAt: null }, { $set: { revokedAt: new Date() } });\n}\n\nexport async function verifyRefreshSubject(token: string) {\n  // Keep a signed wrapper if needed later; currently returns raw token presence.\n  await jwtVerify(\n    await new SignJWT({ token }).setProtectedHeader({ alg: \"HS256\" }).setExpirationTime(\"7d\").sign(refreshSecret),\n    refreshSecret,\n  );\n  return true;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AAAA;AACA;AACA;;;;;AAEA,MAAM,eAAe,IAAI,cAAc,MAAM,CAAC,yIAAG,CAAC,YAAY;AAC9D,MAAM,gBAAgB,IAAI,cAAc,MAAM,CAAC,yIAAG,CAAC,aAAa;AAQzD,eAAe,kBAAkB,OAA2B;IACjE,OAAO,IAAI,sLAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,GAAG,yIAAG,CAAC,qBAAqB,CAAC,CAAC,CAAC,EACjD,IAAI,CAAC;AACV;AAEO,eAAe,mBAAmB,MAAc;IACrD,MAAM,WAAW,gHAAM,CAAC,UAAU;IAClC,MAAM,YAAY,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,UAAU,MAAM,CAAC;IACtE,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,yIAAG,CAAC,mBAAmB,GAAG,KAAK,KAAK,KAAK;IAEjF,MAAM,oJAAY,CAAC,MAAM,CAAC;QAAE;QAAQ;QAAW;IAAU;IACzD,OAAO;AACT;AAEO,eAAe,kBAAkB,KAAa;IACnD,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,0LAAS,EAAC,OAAO;IAC3C,OAAO;AACT;AAEO,eAAe,mBAAmB,MAAc,EAAE,aAAqB;IAC5E,MAAM,eAAe,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,eAAe,MAAM,CAAC;IAC9E,MAAM,WAAW,MAAM,oJAAY,CAAC,OAAO,CAAC;QAAE;QAAQ,WAAW;QAAc,WAAW;IAAK;IAC/F,IAAI,CAAC,YAAY,SAAS,SAAS,GAAG,IAAI,QAAQ;QAChD,OAAO;IACT;IAEA,SAAS,SAAS,GAAG,IAAI;IACzB,MAAM,SAAS,IAAI;IACnB,OAAO,mBAAmB;AAC5B;AAEO,eAAe,mBAAmB,KAAa;IACpD,MAAM,YAAY,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,OAAO,MAAM,CAAC;IACnE,MAAM,oJAAY,CAAC,SAAS,CAAC;QAAE;QAAW,WAAW;IAAK,GAAG;QAAE,MAAM;YAAE,WAAW,IAAI;QAAO;IAAE;AACjG;AAEO,eAAe,qBAAqB,KAAa;IACtD,+EAA+E;IAC/E,MAAM,IAAA,0LAAS,EACb,MAAM,IAAI,sLAAO,CAAC;QAAE;IAAM,GAAG,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAAG,iBAAiB,CAAC,MAAM,IAAI,CAAC,gBAC/F;IAEF,OAAO;AACT"}},
    {"offset": {"line": 641, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/security/casbin/enforcer.ts"],"sourcesContent":["import { newEnforcer, newModelFromString } from \"casbin\";\nimport { Role, User } from \"@/src/db/models\";\n\nconst modelText = `\n[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = g(r.sub, p.sub) && r.obj == p.obj && r.act == p.act\n`;\n\nexport async function enforceUserPermission(userId: string, resource: string, action: string) {\n  const user = await User.findById(userId).lean();\n  if (!user) {\n    return false;\n  }\n\n  const roleDocs = await Role.find({ _id: { $in: user.roleIds } }).lean();\n  const enforcer = await newEnforcer(newModelFromString(modelText));\n  for (const role of roleDocs) {\n    await enforcer.addGroupingPolicy(userId, role.name);\n    for (const perm of role.permissions) {\n      const [obj, act] = perm.split(\":\");\n      if (obj && act) {\n        await enforcer.addPolicy(role.name, obj, act);\n      }\n    }\n  }\n\n  return enforcer.enforce(userId, resource, action);\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AAAA;AACA;;;AAEA,MAAM,YAAY,CAAC;;;;;;;;;;;;;;;AAenB,CAAC;AAEM,eAAe,sBAAsB,MAAc,EAAE,QAAgB,EAAE,MAAc;IAC1F,MAAM,OAAO,MAAM,4IAAI,CAAC,QAAQ,CAAC,QAAQ,IAAI;IAC7C,IAAI,CAAC,MAAM;QACT,OAAO;IACT;IAEA,MAAM,WAAW,MAAM,4IAAI,CAAC,IAAI,CAAC;QAAE,KAAK;YAAE,KAAK,KAAK,OAAO;QAAC;IAAE,GAAG,IAAI;IACrE,MAAM,WAAW,MAAM,IAAA,gLAAW,EAAC,IAAA,6LAAkB,EAAC;IACtD,KAAK,MAAM,QAAQ,SAAU;QAC3B,MAAM,SAAS,iBAAiB,CAAC,QAAQ,KAAK,IAAI;QAClD,KAAK,MAAM,QAAQ,KAAK,WAAW,CAAE;YACnC,MAAM,CAAC,KAAK,IAAI,GAAG,KAAK,KAAK,CAAC;YAC9B,IAAI,OAAO,KAAK;gBACd,MAAM,SAAS,SAAS,CAAC,KAAK,IAAI,EAAE,KAAK;YAC3C;QACF;IACF;IAEA,OAAO,SAAS,OAAO,CAAC,QAAQ,UAAU;AAC5C"}},
    {"offset": {"line": 693, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/lib/request-auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\nimport { verifyAccessToken } from \"@/src/lib/tokens\";\nimport { enforceUserPermission } from \"@/src/security/casbin/enforcer\";\n\nexport async function requireAuth(req: NextRequest) {\n  const authHeader = req.headers.get(\"authorization\");\n  if (!authHeader?.startsWith(\"Bearer \")) {\n    return null;\n  }\n\n  const token = authHeader.substring(\"Bearer \".length);\n  try {\n    return await verifyAccessToken(token);\n  } catch {\n    return null;\n  }\n}\n\nexport async function requirePermission(\n  req: NextRequest,\n  resource: string,\n  action: string,\n) {\n  const user = await requireAuth(req);\n  if (!user?.sub) {\n    return { allowed: false, user: null };\n  }\n\n  const allowed = await enforceUserPermission(user.sub, resource, action);\n  return { allowed, user };\n}\n"],"names":[],"mappings":";;;;;;AACA;AACA;;;AAEO,eAAe,YAAY,GAAgB;IAChD,MAAM,aAAa,IAAI,OAAO,CAAC,GAAG,CAAC;IACnC,IAAI,CAAC,YAAY,WAAW,YAAY;QACtC,OAAO;IACT;IAEA,MAAM,QAAQ,WAAW,SAAS,CAAC,UAAU,MAAM;IACnD,IAAI;QACF,OAAO,MAAM,IAAA,0JAAiB,EAAC;IACjC,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,kBACpB,GAAgB,EAChB,QAAgB,EAChB,MAAc;IAEd,MAAM,OAAO,MAAM,YAAY;IAC/B,IAAI,CAAC,MAAM,KAAK;QACd,OAAO;YAAE,SAAS;YAAO,MAAM;QAAK;IACtC;IAEA,MAAM,UAAU,MAAM,IAAA,+KAAqB,EAAC,KAAK,GAAG,EAAE,UAAU;IAChE,OAAO;QAAE;QAAS;IAAK;AACzB"}},
    {"offset": {"line": 751, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/attendance/math.ts"],"sourcesContent":["export function computeTotalSeconds(clockInAt: Date, clockOutAt: Date) {\n  return Math.max(0, Math.floor((clockOutAt.getTime() - clockInAt.getTime()) / 1000));\n}\n"],"names":[],"mappings":";;;;AAAO,SAAS,oBAAoB,SAAe,EAAE,UAAgB;IACnE,OAAO,KAAK,GAAG,CAAC,GAAG,KAAK,KAAK,CAAC,CAAC,WAAW,OAAO,KAAK,UAAU,OAAO,EAAE,IAAI;AAC/E"}},
    {"offset": {"line": 762, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/attendance/service.ts"],"sourcesContent":["import geoip from \"geoip-lite\";\nimport { AttendanceEvent, Device, WorkSession } from \"@/src/db/models\";\nimport { env } from \"@/src/lib/env\";\nimport { computeTotalSeconds } from \"@/src/attendance/math\";\n\nexport async function registerDevice(params: {\n  userId: string;\n  hostname: string;\n  osVersion: string;\n  deviceFingerprint: string;\n  appVersion: string;\n}) {\n  return Device.findOneAndUpdate(\n    {\n      userId: params.userId,\n      deviceFingerprint: params.deviceFingerprint,\n    },\n    params,\n    { upsert: true, new: true },\n  );\n}\n\nfunction geoFromIp(ip: string) {\n  const lookup = geoip.lookup(ip);\n  if (!lookup) {\n    return { country: env.geoFallbackCountry, city: \"\", ll: [] as number[] };\n  }\n\n  return {\n    country: lookup.country || env.geoFallbackCountry,\n    city: lookup.city || \"\",\n    ll: lookup.ll || [],\n  };\n}\n\nexport async function clockIn(params: {\n  userId: string;\n  ip: string;\n  deviceId: string;\n  faceScore: number;\n  verificationStatus: string;\n}) {\n  const existingOpenSession = await WorkSession.findOne({\n    userId: params.userId,\n    clockOutAt: null,\n  });\n  if (existingOpenSession) {\n    throw new Error(\"Open work session already exists.\");\n  }\n\n  const now = new Date();\n  await WorkSession.create({\n    userId: params.userId,\n    clockInAt: now,\n    ipAtIn: params.ip,\n    deviceIdAtIn: params.deviceId,\n  });\n\n  await AttendanceEvent.create({\n    userId: params.userId,\n    type: \"clockIn\",\n    timestamp: now,\n    ip: params.ip,\n    geo: geoFromIp(params.ip),\n    deviceId: params.deviceId,\n    faceScore: params.faceScore,\n    verificationStatus: params.verificationStatus,\n  });\n}\n\nexport async function clockOut(params: {\n  userId: string;\n  ip: string;\n  deviceId: string;\n  faceScore: number;\n  verificationStatus: string;\n}) {\n  const openSession = await WorkSession.findOne({\n    userId: params.userId,\n    clockOutAt: null,\n  });\n  if (!openSession) {\n    throw new Error(\"No open session found to clock out.\");\n  }\n\n  const now = new Date();\n  const totalSeconds = computeTotalSeconds(openSession.clockInAt, now);\n  openSession.clockOutAt = now;\n  openSession.totalSeconds = totalSeconds;\n  openSession.ipAtOut = params.ip;\n  openSession.deviceIdAtOut = params.deviceId;\n  await openSession.save();\n\n  await AttendanceEvent.create({\n    userId: params.userId,\n    type: \"clockOut\",\n    timestamp: now,\n    ip: params.ip,\n    geo: geoFromIp(params.ip),\n    deviceId: params.deviceId,\n    faceScore: params.faceScore,\n    verificationStatus: params.verificationStatus,\n  });\n\n  return openSession;\n}\n\nexport async function getTodaySummary(userId: string) {\n  const start = new Date();\n  start.setUTCHours(0, 0, 0, 0);\n  const end = new Date();\n  end.setUTCHours(23, 59, 59, 999);\n\n  const sessions = await WorkSession.find({\n    userId,\n    clockInAt: { $gte: start, $lte: end },\n  }).lean();\n\n  const totalSeconds = sessions.reduce((acc, s) => acc + (s.totalSeconds || 0), 0);\n  return { totalSeconds, sessions };\n}\n\nexport async function getHoursByDay(userId: string, days = 30) {\n  const start = new Date();\n  start.setDate(start.getDate() - days);\n  start.setUTCHours(0, 0, 0, 0);\n  const end = new Date();\n  end.setUTCHours(23, 59, 59, 999);\n\n  const sessions = await WorkSession.find({\n    userId,\n    clockInAt: { $gte: start, $lte: end },\n    clockOutAt: { $ne: null },\n  }).lean();\n\n  const byDate = new Map<string, number>();\n  for (let i = 0; i < days; i += 1) {\n    const d = new Date(start);\n    d.setDate(d.getDate() + i);\n    byDate.set(d.toISOString().slice(0, 10), 0);\n  }\n\n  for (const s of sessions) {\n    const dateStr = new Date(s.clockInAt).toISOString().slice(0, 10);\n    byDate.set(dateStr, (byDate.get(dateStr) ?? 0) + (s.totalSeconds ?? 0));\n  }\n\n  return Array.from(byDate.entries())\n    .sort((a, b) => a[0].localeCompare(b[0]))\n    .map(([date, totalSeconds]) => ({ date, totalSeconds }));\n}\n\nexport async function getUserAttendance(userId: string, days = 30) {\n  const start = new Date();\n  start.setDate(start.getDate() - days);\n  const sessions = await WorkSession.find({\n    userId,\n    clockInAt: { $gte: start },\n  })\n    .sort({ clockInAt: -1 })\n    .limit(100)\n    .lean();\n\n  const hoursByDay = await getHoursByDay(userId, days);\n  return { sessions, hoursByDay };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,eAAe,MAMpC;IACC,OAAO,8IAAM,CAAC,gBAAgB,CAC5B;QACE,QAAQ,OAAO,MAAM;QACrB,mBAAmB,OAAO,iBAAiB;IAC7C,GACA,QACA;QAAE,QAAQ;QAAM,KAAK;IAAK;AAE9B;AAEA,SAAS,UAAU,EAAU;IAC3B,MAAM,SAAS,yKAAK,CAAC,MAAM,CAAC;IAC5B,IAAI,CAAC,QAAQ;QACX,OAAO;YAAE,SAAS,yIAAG,CAAC,kBAAkB;YAAE,MAAM;YAAI,IAAI,EAAE;QAAa;IACzE;IAEA,OAAO;QACL,SAAS,OAAO,OAAO,IAAI,yIAAG,CAAC,kBAAkB;QACjD,MAAM,OAAO,IAAI,IAAI;QACrB,IAAI,OAAO,EAAE,IAAI,EAAE;IACrB;AACF;AAEO,eAAe,QAAQ,MAM7B;IACC,MAAM,sBAAsB,MAAM,mJAAW,CAAC,OAAO,CAAC;QACpD,QAAQ,OAAO,MAAM;QACrB,YAAY;IACd;IACA,IAAI,qBAAqB;QACvB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,MAAM,IAAI;IAChB,MAAM,mJAAW,CAAC,MAAM,CAAC;QACvB,QAAQ,OAAO,MAAM;QACrB,WAAW;QACX,QAAQ,OAAO,EAAE;QACjB,cAAc,OAAO,QAAQ;IAC/B;IAEA,MAAM,uJAAe,CAAC,MAAM,CAAC;QAC3B,QAAQ,OAAO,MAAM;QACrB,MAAM;QACN,WAAW;QACX,IAAI,OAAO,EAAE;QACb,KAAK,UAAU,OAAO,EAAE;QACxB,UAAU,OAAO,QAAQ;QACzB,WAAW,OAAO,SAAS;QAC3B,oBAAoB,OAAO,kBAAkB;IAC/C;AACF;AAEO,eAAe,SAAS,MAM9B;IACC,MAAM,cAAc,MAAM,mJAAW,CAAC,OAAO,CAAC;QAC5C,QAAQ,OAAO,MAAM;QACrB,YAAY;IACd;IACA,IAAI,CAAC,aAAa;QAChB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,MAAM,IAAI;IAChB,MAAM,eAAe,IAAA,iKAAmB,EAAC,YAAY,SAAS,EAAE;IAChE,YAAY,UAAU,GAAG;IACzB,YAAY,YAAY,GAAG;IAC3B,YAAY,OAAO,GAAG,OAAO,EAAE;IAC/B,YAAY,aAAa,GAAG,OAAO,QAAQ;IAC3C,MAAM,YAAY,IAAI;IAEtB,MAAM,uJAAe,CAAC,MAAM,CAAC;QAC3B,QAAQ,OAAO,MAAM;QACrB,MAAM;QACN,WAAW;QACX,IAAI,OAAO,EAAE;QACb,KAAK,UAAU,OAAO,EAAE;QACxB,UAAU,OAAO,QAAQ;QACzB,WAAW,OAAO,SAAS;QAC3B,oBAAoB,OAAO,kBAAkB;IAC/C;IAEA,OAAO;AACT;AAEO,eAAe,gBAAgB,MAAc;IAClD,MAAM,QAAQ,IAAI;IAClB,MAAM,WAAW,CAAC,GAAG,GAAG,GAAG;IAC3B,MAAM,MAAM,IAAI;IAChB,IAAI,WAAW,CAAC,IAAI,IAAI,IAAI;IAE5B,MAAM,WAAW,MAAM,mJAAW,CAAC,IAAI,CAAC;QACtC;QACA,WAAW;YAAE,MAAM;YAAO,MAAM;QAAI;IACtC,GAAG,IAAI;IAEP,MAAM,eAAe,SAAS,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,CAAC,EAAE,YAAY,IAAI,CAAC,GAAG;IAC9E,OAAO;QAAE;QAAc;IAAS;AAClC;AAEO,eAAe,cAAc,MAAc,EAAE,OAAO,EAAE;IAC3D,MAAM,QAAQ,IAAI;IAClB,MAAM,OAAO,CAAC,MAAM,OAAO,KAAK;IAChC,MAAM,WAAW,CAAC,GAAG,GAAG,GAAG;IAC3B,MAAM,MAAM,IAAI;IAChB,IAAI,WAAW,CAAC,IAAI,IAAI,IAAI;IAE5B,MAAM,WAAW,MAAM,mJAAW,CAAC,IAAI,CAAC;QACtC;QACA,WAAW;YAAE,MAAM;YAAO,MAAM;QAAI;QACpC,YAAY;YAAE,KAAK;QAAK;IAC1B,GAAG,IAAI;IAEP,MAAM,SAAS,IAAI;IACnB,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,KAAK,EAAG;QAChC,MAAM,IAAI,IAAI,KAAK;QACnB,EAAE,OAAO,CAAC,EAAE,OAAO,KAAK;QACxB,OAAO,GAAG,CAAC,EAAE,WAAW,GAAG,KAAK,CAAC,GAAG,KAAK;IAC3C;IAEA,KAAK,MAAM,KAAK,SAAU;QACxB,MAAM,UAAU,IAAI,KAAK,EAAE,SAAS,EAAE,WAAW,GAAG,KAAK,CAAC,GAAG;QAC7D,OAAO,GAAG,CAAC,SAAS,CAAC,OAAO,GAAG,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,YAAY,IAAI,CAAC;IACvE;IAEA,OAAO,MAAM,IAAI,CAAC,OAAO,OAAO,IAC7B,IAAI,CAAC,CAAC,GAAG,IAAM,CAAC,CAAC,EAAE,CAAC,aAAa,CAAC,CAAC,CAAC,EAAE,GACtC,GAAG,CAAC,CAAC,CAAC,MAAM,aAAa,GAAK,CAAC;YAAE;YAAM;QAAa,CAAC;AAC1D;AAEO,eAAe,kBAAkB,MAAc,EAAE,OAAO,EAAE;IAC/D,MAAM,QAAQ,IAAI;IAClB,MAAM,OAAO,CAAC,MAAM,OAAO,KAAK;IAChC,MAAM,WAAW,MAAM,mJAAW,CAAC,IAAI,CAAC;QACtC;QACA,WAAW;YAAE,MAAM;QAAM;IAC3B,GACG,IAAI,CAAC;QAAE,WAAW,CAAC;IAAE,GACrB,KAAK,CAAC,KACN,IAAI;IAEP,MAAM,aAAa,MAAM,cAAc,QAAQ;IAC/C,OAAO;QAAE;QAAU;IAAW;AAChC"}},
    {"offset": {"line": 931, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/app/api/attendance/my/today/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { connectMongo } from \"@/src/lib/mongodb\";\nimport { requireAuth } from \"@/src/lib/request-auth\";\nimport { getTodaySummary } from \"@/src/attendance/service\";\n\nexport async function GET(req: NextRequest) {\n  await connectMongo();\n  const user = await requireAuth(req);\n  if (!user?.sub) {\n    return NextResponse.json({ message: \"Unauthorized.\" }, { status: 401 });\n  }\n\n  const summary = await getTodaySummary(user.sub);\n  return NextResponse.json(summary);\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,IAAI,GAAgB;IACxC,MAAM,IAAA,sJAAY;IAClB,MAAM,OAAO,MAAM,IAAA,6JAAW,EAAC;IAC/B,IAAI,CAAC,MAAM,KAAK;QACd,OAAO,+JAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAgB,GAAG;YAAE,QAAQ;QAAI;IACvE;IAEA,MAAM,UAAU,MAAM,IAAA,gKAAe,EAAC,KAAK,GAAG;IAC9C,OAAO,+JAAY,CAAC,IAAI,CAAC;AAC3B"}}]
}