{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/lib/env.ts"],"sourcesContent":["export const env = {\n  mongodbUri: process.env.MONGODB_URI || \"mongodb://localhost:27017/workforce\",\n  accessSecret: process.env.JWT_ACCESS_SECRET || \"dev-access-secret-change-me\",\n  refreshSecret: process.env.JWT_REFRESH_SECRET || \"dev-refresh-secret-change-me\",\n  accessTokenTtlMinutes: Number(process.env.ACCESS_TOKEN_TTL_MINUTES || \"15\"),\n  refreshTokenTtlDays: Number(process.env.REFRESH_TOKEN_TTL_DAYS || \"30\"),\n  geoFallbackCountry: process.env.GEOIP_FALLBACK_COUNTRY || \"Unknown\",\n  /** 32-byte hex key for AES-GCM embedding encryption. Generate: openssl rand -hex 32 */\n  faceEmbeddingKey: process.env.FACE_EMBEDDING_KEY || \"0000000000000000000000000000000000000000000000000000000000000000\",\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,MAAM;IACjB,YAAY,QAAQ,GAAG,CAAC,WAAW,IAAI;IACvC,cAAc,QAAQ,GAAG,CAAC,iBAAiB,IAAI;IAC/C,eAAe,QAAQ,GAAG,CAAC,kBAAkB,IAAI;IACjD,uBAAuB,OAAO,QAAQ,GAAG,CAAC,wBAAwB,IAAI;IACtE,qBAAqB,OAAO,QAAQ,GAAG,CAAC,sBAAsB,IAAI;IAClE,oBAAoB,QAAQ,GAAG,CAAC,sBAAsB,IAAI;IAC1D,qFAAqF,GACrF,kBAAkB,QAAQ,GAAG,CAAC,kBAAkB,IAAI;AACtD"}},
    {"offset": {"line": 63, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/lib/mongodb.ts"],"sourcesContent":["import mongoose from \"mongoose\";\nimport { env } from \"@/src/lib/env\";\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var mongooseConn: Promise<typeof mongoose> | undefined;\n}\n\nexport function connectMongo() {\n  if (!global.mongooseConn) {\n    global.mongooseConn = mongoose.connect(env.mongodbUri, { dbName: \"workforce\" });\n  }\n  return global.mongooseConn;\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAOO,SAAS;IACd,IAAI,CAAC,OAAO,YAAY,EAAE;QACxB,OAAO,YAAY,GAAG,mKAAQ,CAAC,OAAO,CAAC,yIAAG,CAAC,UAAU,EAAE;YAAE,QAAQ;QAAY;IAC/E;IACA,OAAO,OAAO,YAAY;AAC5B"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/db/models.ts"],"sourcesContent":["import mongoose, { Schema, type InferSchemaType } from \"mongoose\";\n\nconst userSchema = new Schema(\n  {\n    email: { type: String, unique: true, required: true, lowercase: true, trim: true },\n    passwordHash: { type: String, required: true },\n    roleIds: [{ type: Schema.Types.ObjectId, ref: \"Role\" }],\n    isActive: { type: Boolean, default: true },\n    profile: {\n      displayName: { type: String, default: \"\" },\n      profilePictureBase64: { type: String, default: \"\" },\n      employeeCode: { type: String, default: \"\" },\n      firstName: { type: String, default: \"\" },\n      lastName: { type: String, default: \"\" },\n      nationality: { type: String, default: \"\" },\n      dateOfBirth: { type: Date, default: null },\n      gender: { type: String, default: \"\" },\n      maritalStatus: { type: String, default: \"\" },\n      jobTitle: { type: String, default: \"\" },\n      department: { type: String, default: \"\" },\n      manager: { type: String, default: \"\" },\n      phone: { type: String, default: \"\" },\n      timezone: { type: String, default: \"\" },\n      skills: [{ type: String }],\n      education: { type: String, default: \"\" },\n      languages: [{ type: String }],\n      dependents: [{ type: String }],\n      contacts: [{ type: String }],\n    },\n  },\n  { timestamps: true },\n);\n\nconst roleSchema = new Schema(\n  {\n    name: { type: String, unique: true, required: true, trim: true },\n    description: { type: String, default: \"\" },\n    permissions: [{ type: String, required: true }],\n  },\n  { timestamps: true },\n);\n\nconst refreshTokenSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    tokenHash: { type: String, required: true, unique: true },\n    expiresAt: { type: Date, required: true, index: true },\n    revokedAt: { type: Date, default: null },\n  },\n  { timestamps: true },\n);\n\nconst deviceSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    hostname: { type: String, required: true },\n    osVersion: { type: String, default: \"\" },\n    deviceFingerprint: { type: String, required: true, index: true },\n    appVersion: { type: String, default: \"\" },\n  },\n  { timestamps: true },\n);\n\nconst faceTemplateSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, unique: true },\n    /** Encrypted embeddings per pose (AES-GCM). front, left, right. */\n    embeddingFront: { type: String, default: null },\n    embeddingLeft: { type: String, default: null },\n    embeddingRight: { type: String, default: null },\n    /** Model version for embedding compatibility. */\n    modelVersion: { type: Number, default: 1 },\n    status: { type: String, default: \"active\" },\n    /** @deprecated legacy single embedding - migrate to embeddingFront/Left/Right */\n    embeddingVector: [{ type: Number }],\n    version: { type: Number, default: 1 },\n  },\n  { timestamps: true },\n);\n\nconst attendanceEventSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    type: { type: String, enum: [\"clockIn\", \"clockOut\"], required: true },\n    timestamp: { type: Date, required: true, index: true },\n    ip: { type: String, default: \"\" },\n    geo: {\n      country: { type: String, default: \"\" },\n      city: { type: String, default: \"\" },\n      ll: [{ type: Number }],\n    },\n    deviceId: { type: Schema.Types.ObjectId, ref: \"Device\" },\n    faceScore: { type: Number, default: 0 },\n    verificationStatus: { type: String, default: \"pending\" },\n  },\n  { timestamps: true },\n);\n\nconst workSessionSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    clockInAt: { type: Date, required: true, index: true },\n    clockOutAt: { type: Date, default: null, index: true },\n    totalSeconds: { type: Number, default: 0 },\n    ipAtIn: { type: String, default: \"\" },\n    ipAtOut: { type: String, default: \"\" },\n    deviceIdAtIn: { type: Schema.Types.ObjectId, ref: \"Device\" },\n    deviceIdAtOut: { type: Schema.Types.ObjectId, ref: \"Device\" },\n  },\n  { timestamps: true },\n);\n\nconst auditLogSchema = new Schema(\n  {\n    actorUserId: { type: Schema.Types.ObjectId, ref: \"User\" },\n    action: { type: String, required: true },\n    details: { type: Schema.Types.Mixed, default: {} },\n  },\n  { timestamps: true },\n);\n\nconst awayAlertSchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    employeeEmail: { type: String, required: true },\n    awayAt: { type: Date, required: true, default: () => new Date() },\n    minutesAway: { type: Number, required: true, default: 15 },\n  },\n  { timestamps: true },\n);\n\nconst companyStructureSchema = new Schema(\n  {\n    name: { type: String, required: true, trim: true },\n    address: { type: String, default: \"\" },\n    type: { type: String, default: \"Department\" },\n    country: { type: String, default: \"\" },\n    timeZone: { type: String, default: \"\" },\n    parentStructure: { type: String, default: \"\" },\n  },\n  { timestamps: true },\n);\n\nconst loginHistorySchema = new Schema(\n  {\n    userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\n    loginTime: { type: Date, required: true },\n    loginTimeFormatted: { type: String, required: true },\n    ipAddress: { type: String, default: \"\" },\n    systemName: { type: String, default: \"\" },\n    location: { type: String, default: \"\" },\n  },\n  { timestamps: true },\n);\n\nexport type UserDoc = InferSchemaType<typeof userSchema>;\nexport type RoleDoc = InferSchemaType<typeof roleSchema>;\n\nexport const User = mongoose.models.User || mongoose.model(\"User\", userSchema);\nexport const Role = mongoose.models.Role || mongoose.model(\"Role\", roleSchema);\nexport const RefreshToken =\n  mongoose.models.RefreshToken || mongoose.model(\"RefreshToken\", refreshTokenSchema);\nexport const Device = mongoose.models.Device || mongoose.model(\"Device\", deviceSchema);\nexport const FaceTemplate =\n  mongoose.models.FaceTemplate || mongoose.model(\"FaceTemplate\", faceTemplateSchema);\nexport const AttendanceEvent =\n  mongoose.models.AttendanceEvent || mongoose.model(\"AttendanceEvent\", attendanceEventSchema);\nexport const WorkSession =\n  mongoose.models.WorkSession || mongoose.model(\"WorkSession\", workSessionSchema);\nexport const AuditLog = mongoose.models.AuditLog || mongoose.model(\"AuditLog\", auditLogSchema);\nexport const CompanyStructure =\n  mongoose.models.CompanyStructure || mongoose.model(\"CompanyStructure\", companyStructureSchema);\nexport const AwayAlert =\n  mongoose.models.AwayAlert || mongoose.model(\"AwayAlert\", awayAlertSchema);\nexport const LoginHistory =\n  mongoose.models.LoginHistory || mongoose.model(\"LoginHistory\", loginHistorySchema);\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 558, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/src/lib/tokens.ts"],"sourcesContent":["import crypto from \"crypto\";\nimport { SignJWT, jwtVerify } from \"jose\";\nimport { env } from \"@/src/lib/env\";\nimport { RefreshToken } from \"@/src/db/models\";\n\nconst accessSecret = new TextEncoder().encode(env.accessSecret);\nconst refreshSecret = new TextEncoder().encode(env.refreshSecret);\n\nexport type AccessTokenPayload = {\n  sub: string;\n  email: string;\n  roles: string[];\n};\n\nexport async function createAccessToken(payload: AccessTokenPayload) {\n  return new SignJWT(payload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(`${env.accessTokenTtlMinutes}m`)\n    .sign(accessSecret);\n}\n\nexport async function createRefreshToken(userId: string) {\n  const rawToken = crypto.randomUUID();\n  const tokenHash = crypto.createHash(\"sha256\").update(rawToken).digest(\"hex\");\n  const expiresAt = new Date(Date.now() + env.refreshTokenTtlDays * 24 * 60 * 60 * 1000);\n\n  await RefreshToken.create({ userId, tokenHash, expiresAt });\n  return rawToken;\n}\n\nexport async function verifyAccessToken(token: string) {\n  const { payload } = await jwtVerify(token, accessSecret);\n  return payload as unknown as AccessTokenPayload;\n}\n\nexport async function rotateRefreshToken(userId: string, incomingToken: string) {\n  const incomingHash = crypto.createHash(\"sha256\").update(incomingToken).digest(\"hex\");\n  const existing = await RefreshToken.findOne({ userId, tokenHash: incomingHash, revokedAt: null });\n  if (!existing || existing.expiresAt < new Date()) {\n    return null;\n  }\n\n  existing.revokedAt = new Date();\n  await existing.save();\n  return createRefreshToken(userId);\n}\n\nexport async function revokeRefreshToken(token: string) {\n  const tokenHash = crypto.createHash(\"sha256\").update(token).digest(\"hex\");\n  await RefreshToken.updateOne({ tokenHash, revokedAt: null }, { $set: { revokedAt: new Date() } });\n}\n\nexport async function verifyRefreshSubject(token: string) {\n  // Keep a signed wrapper if needed later; currently returns raw token presence.\n  await jwtVerify(\n    await new SignJWT({ token }).setProtectedHeader({ alg: \"HS256\" }).setExpirationTime(\"7d\").sign(refreshSecret),\n    refreshSecret,\n  );\n  return true;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AAAA;AACA;AACA;;;;;AAEA,MAAM,eAAe,IAAI,cAAc,MAAM,CAAC,yIAAG,CAAC,YAAY;AAC9D,MAAM,gBAAgB,IAAI,cAAc,MAAM,CAAC,yIAAG,CAAC,aAAa;AAQzD,eAAe,kBAAkB,OAA2B;IACjE,OAAO,IAAI,uKAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,GAAG,yIAAG,CAAC,qBAAqB,CAAC,CAAC,CAAC,EACjD,IAAI,CAAC;AACV;AAEO,eAAe,mBAAmB,MAAc;IACrD,MAAM,WAAW,gHAAM,CAAC,UAAU;IAClC,MAAM,YAAY,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,UAAU,MAAM,CAAC;IACtE,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,yIAAG,CAAC,mBAAmB,GAAG,KAAK,KAAK,KAAK;IAEjF,MAAM,oJAAY,CAAC,MAAM,CAAC;QAAE;QAAQ;QAAW;IAAU;IACzD,OAAO;AACT;AAEO,eAAe,kBAAkB,KAAa;IACnD,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,2KAAS,EAAC,OAAO;IAC3C,OAAO;AACT;AAEO,eAAe,mBAAmB,MAAc,EAAE,aAAqB;IAC5E,MAAM,eAAe,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,eAAe,MAAM,CAAC;IAC9E,MAAM,WAAW,MAAM,oJAAY,CAAC,OAAO,CAAC;QAAE;QAAQ,WAAW;QAAc,WAAW;IAAK;IAC/F,IAAI,CAAC,YAAY,SAAS,SAAS,GAAG,IAAI,QAAQ;QAChD,OAAO;IACT;IAEA,SAAS,SAAS,GAAG,IAAI;IACzB,MAAM,SAAS,IAAI;IACnB,OAAO,mBAAmB;AAC5B;AAEO,eAAe,mBAAmB,KAAa;IACpD,MAAM,YAAY,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,OAAO,MAAM,CAAC;IACnE,MAAM,oJAAY,CAAC,SAAS,CAAC;QAAE;QAAW,WAAW;IAAK,GAAG;QAAE,MAAM;YAAE,WAAW,IAAI;QAAO;IAAE;AACjG;AAEO,eAAe,qBAAqB,KAAa;IACtD,+EAA+E;IAC/E,MAAM,IAAA,2KAAS,EACb,MAAM,IAAI,uKAAO,CAAC;QAAE;IAAM,GAAG,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAAG,iBAAiB,CAAC,MAAM,IAAI,CAAC,gBAC/F;IAEF,OAAO;AACT"}},
    {"offset": {"line": 641, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/flow/workflow-core/apps/web/app/api/auth/logout/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport { connectMongo } from \"@/src/lib/mongodb\";\nimport { revokeRefreshToken } from \"@/src/lib/tokens\";\n\nconst bodySchema = z.object({\n  refreshToken: z.string().min(10),\n});\n\nexport async function POST(req: Request) {\n  await connectMongo();\n  const parsed = bodySchema.safeParse(await req.json());\n  if (!parsed.success) {\n    return NextResponse.json({ message: \"Invalid payload.\" }, { status: 400 });\n  }\n\n  await revokeRefreshToken(parsed.data.refreshToken);\n  return NextResponse.json({ ok: true });\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,aAAa,yKAAC,CAAC,MAAM,CAAC;IAC1B,cAAc,yKAAC,CAAC,MAAM,GAAG,GAAG,CAAC;AAC/B;AAEO,eAAe,KAAK,GAAY;IACrC,MAAM,IAAA,sJAAY;IAClB,MAAM,SAAS,WAAW,SAAS,CAAC,MAAM,IAAI,IAAI;IAClD,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAmB,GAAG;YAAE,QAAQ;QAAI;IAC1E;IAEA,MAAM,IAAA,2JAAkB,EAAC,OAAO,IAAI,CAAC,YAAY;IACjD,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,IAAI;IAAK;AACtC"}}]
}